#!/usr/bin/env node

/**
 * üöÄ PREPARE VERCEL DEPLOYMENT
 * Script untuk mempersiapkan deployment ke Vercel dengan Supabase
 */

import fs from 'fs';
import { execSync } from 'child_process';

// Colors for console output
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  magenta: '\x1b[35m',
  cyan: '\x1b[36m'
};

function colorLog(color, message) {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

async function main() {
  console.clear();
  
  colorLog('cyan', 'üöÄ ===== PREPARE VERCEL DEPLOYMENT =====');
  colorLog('yellow', 'üìã Mempersiapkan POS CafeLux untuk deployment ke Vercel\n');

  // Step 1: Check Git status
  colorLog('blue', '1Ô∏è‚É£ Checking Git status...');
  
  try {
    const gitStatus = execSync('git status --porcelain', { encoding: 'utf8' });
    if (gitStatus.trim()) {
      colorLog('yellow', '   ‚ö†Ô∏è  Ada perubahan yang belum di-commit:');
      console.log(gitStatus);
    } else {
      colorLog('green', '   ‚úÖ Working directory clean');
    }
  } catch (error) {
    colorLog('red', '   ‚ùå Git tidak tersedia atau belum diinisialisasi');
    colorLog('yellow', '   üí° Pastikan Git sudah terinstall dan repository sudah diinisialisasi');
  }

  // Step 2: Create deployment guide
  colorLog('blue', '\n2Ô∏è‚É£ Creating deployment guide...');
  
  const deploymentGuide = `# üöÄ VERCEL DEPLOYMENT GUIDE - POS CAFELUX

## üìã Prerequisites
1. ‚úÖ Supabase project sudah dibuat
2. ‚úÖ GitHub repository sudah siap
3. ‚úÖ Vercel account sudah tersedia

## üîß Environment Variables untuk Vercel

Copy environment variables berikut ke Vercel Dashboard > Settings > Environment Variables:

\`\`\`bash
# ===== SUPABASE CONFIGURATION =====
DATABASE_URL=postgresql://postgres:[YOUR_PASSWORD]@db.[YOUR_PROJECT_REF].supabase.co:5432/postgres
NEXT_PUBLIC_SUPABASE_URL=https://[YOUR_PROJECT_REF].supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=[YOUR_ANON_KEY]
SUPABASE_SERVICE_ROLE_KEY=[YOUR_SERVICE_ROLE_KEY]

# ===== APPLICATION CONFIGURATION =====
NODE_ENV=production
NEXT_PUBLIC_APP_URL=https://pos-cafelux-main.vercel.app
SESSION_SECRET=[GENERATE_RANDOM_32_CHAR_STRING]
JWT_SECRET=[GENERATE_RANDOM_32_CHAR_STRING]

# ===== OPTIONAL CONFIGURATIONS =====
NEXT_PUBLIC_STORAGE_BUCKET=pos-cafelux-storage
\`\`\`

## üóÑÔ∏è Database Setup di Supabase

1. **Buka Supabase Dashboard** ‚Üí SQL Editor
2. **Run migration scripts** dalam urutan berikut:

### Migration 1: Initial Schema
\`\`\`sql
-- Copy dan paste isi dari: supabase/migrations/20250110000000_initial_pos_cafelux_schema.sql
\`\`\`

### Migration 2: Database Functions
\`\`\`sql
-- Copy dan paste isi dari: supabase/migrations/20250110000001_database_functions.sql
\`\`\`

### Migration 3: Enhanced Features
\`\`\`sql
-- Copy dan paste isi dari: supabase/migrations/20250115000000_enhanced_product_management.sql
\`\`\`

## üöÄ Deployment Steps

### 1. Push ke GitHub
\`\`\`bash
git add .
git commit -m "Setup Supabase for Vercel deployment"
git push origin main
\`\`\`

### 2. Deploy ke Vercel
1. Buka [Vercel Dashboard](https://vercel.com/dashboard)
2. Click "New Project"
3. Import dari GitHub repository
4. Set Framework: **Vite**
5. Set Build Command: **npm run vercel-build**
6. Set Output Directory: **dist/public**
7. Add Environment Variables (dari list di atas)
8. Click "Deploy"

### 3. Verify Deployment
1. Buka URL deployment (https://pos-cafelux-main.vercel.app)
2. Test login dengan: admin / admin123
3. Test semua fitur utama
4. Check browser console untuk error

## üîç Troubleshooting

### Database Connection Issues
- Pastikan DATABASE_URL benar
- Check Supabase project status
- Verify RLS policies

### Build Errors
- Check environment variables
- Verify all dependencies installed
- Check build logs di Vercel

### Runtime Errors
- Check browser console
- Verify API endpoints
- Check Vercel function logs

## üì± Testing Checklist

- [ ] Dashboard loads correctly
- [ ] Product management works
- [ ] Category management works
- [ ] Employee management works
- [ ] Mobile responsive design
- [ ] Search and filter functions
- [ ] Add/Edit modals work
- [ ] API endpoints respond correctly

## üéâ Success!

Jika semua langkah berhasil, aplikasi POS CafeLux akan berjalan di:
**https://pos-cafelux-main.vercel.app**

---
Generated by prepare-vercel-deployment.js
Date: ${new Date().toISOString()}
`;

  fs.writeFileSync('VERCEL_DEPLOYMENT_GUIDE.md', deploymentGuide);
  colorLog('green', '   ‚úÖ Created VERCEL_DEPLOYMENT_GUIDE.md');

  // Step 3: Check production template
  colorLog('blue', '\n3Ô∏è‚É£ Checking production environment template...');
  
  if (fs.existsSync('.env.production.template')) {
    colorLog('green', '   ‚úÖ .env.production.template exists');
  } else {
    colorLog('yellow', '   ‚ö†Ô∏è  Creating .env.production.template...');
    
    const prodTemplate = `# üöÄ PRODUCTION ENVIRONMENT VARIABLES FOR VERCEL
# Copy these to your Vercel dashboard > Settings > Environment Variables

# ===== SUPABASE CONFIGURATION =====
DATABASE_URL=postgresql://postgres:[YOUR_PASSWORD]@db.[YOUR_PROJECT_REF].supabase.co:5432/postgres
NEXT_PUBLIC_SUPABASE_URL=https://[YOUR_PROJECT_REF].supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=[YOUR_ANON_KEY]
SUPABASE_SERVICE_ROLE_KEY=[YOUR_SERVICE_ROLE_KEY]

# ===== APPLICATION CONFIGURATION =====
NODE_ENV=production
NEXT_PUBLIC_APP_URL=https://pos-cafelux-main.vercel.app
SESSION_SECRET=[GENERATE_RANDOM_32_CHAR_STRING]
JWT_SECRET=[GENERATE_RANDOM_32_CHAR_STRING]

# ===== OPTIONAL CONFIGURATIONS =====
NEXT_PUBLIC_STORAGE_BUCKET=pos-cafelux-storage
`;
    
    fs.writeFileSync('.env.production.template', prodTemplate);
    colorLog('green', '   ‚úÖ Created .env.production.template');
  }

  // Step 4: Verify build configuration
  colorLog('blue', '\n4Ô∏è‚É£ Verifying build configuration...');
  
  const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
  const vercelJson = JSON.parse(fs.readFileSync('vercel.json', 'utf8'));
  
  colorLog('green', '   ‚úÖ Package.json scripts:');
  colorLog('blue', `      - build: ${packageJson.scripts.build}`);
  colorLog('blue', `      - vercel-build: ${packageJson.scripts['vercel-build']}`);
  colorLog('blue', `      - start: ${packageJson.scripts.start}`);
  
  colorLog('green', '   ‚úÖ Vercel.json configuration:');
  colorLog('blue', `      - framework: ${vercelJson.framework}`);
  colorLog('blue', `      - buildCommand: ${vercelJson.buildCommand}`);
  colorLog('blue', `      - outputDirectory: ${vercelJson.outputDirectory}`);

  // Step 5: Create commit and push commands
  colorLog('blue', '\n5Ô∏è‚É£ Preparing Git commands...');
  
  const gitCommands = `#!/bin/bash

# üöÄ DEPLOY TO VERCEL - POS CAFELUX
# Script untuk commit dan push ke GitHub

echo "üîÑ Adding all files to Git..."
git add .

echo "üìù Committing changes..."
git commit -m "Setup Supabase localhost and prepare Vercel deployment

- Added Supabase localhost configuration
- Created deployment guides and templates
- Verified build configuration for Vercel
- Ready for production deployment

Features ready:
‚úÖ Product management with real-time search
‚úÖ Category management with color picker
‚úÖ Employee management
‚úÖ Mobile responsive design
‚úÖ API endpoints with Supabase integration
‚úÖ Mock data fallback for development"

echo "üöÄ Pushing to GitHub..."
git push origin main

echo "‚úÖ Code pushed to GitHub!"
echo "üåê Next: Deploy to Vercel using the repository"
echo "üìñ Read VERCEL_DEPLOYMENT_GUIDE.md for detailed instructions"
`;

  fs.writeFileSync('deploy-to-github.sh', gitCommands);
  colorLog('green', '   ‚úÖ Created deploy-to-github.sh');

  // Summary
  colorLog('cyan', '\nüéØ ===== DEPLOYMENT PREPARATION COMPLETE =====');
  colorLog('green', '‚úÖ Deployment guide created');
  colorLog('green', '‚úÖ Environment template ready');
  colorLog('green', '‚úÖ Build configuration verified');
  colorLog('green', '‚úÖ Git commands prepared');

  colorLog('magenta', '\nüìã ===== NEXT STEPS =====');
  colorLog('yellow', 'üîß FOR IMMEDIATE DEPLOYMENT:');
  colorLog('blue', '   1. Run: bash deploy-to-github.sh');
  colorLog('blue', '   2. Go to Vercel Dashboard');
  colorLog('blue', '   3. Import your GitHub repository');
  colorLog('blue', '   4. Follow VERCEL_DEPLOYMENT_GUIDE.md');

  colorLog('yellow', '\nüóÑÔ∏è FOR DATABASE SETUP:');
  colorLog('blue', '   1. Open Supabase Dashboard > SQL Editor');
  colorLog('blue', '   2. Run migration scripts from supabase/migrations/');
  colorLog('blue', '   3. Verify tables are created');

  colorLog('yellow', '\nüåê FOR ENVIRONMENT VARIABLES:');
  colorLog('blue', '   1. Copy from .env.production.template');
  colorLog('blue', '   2. Add to Vercel > Settings > Environment Variables');
  colorLog('blue', '   3. Replace [YOUR_*] placeholders with actual values');

  colorLog('green', '\nüéâ POS CafeLux siap untuk deployment ke Vercel! üöÄ');
  colorLog('blue', 'üìñ Baca VERCEL_DEPLOYMENT_GUIDE.md untuk panduan lengkap');
}

// Run the preparation
main().catch(error => {
  colorLog('red', `\n‚ùå Error: ${error.message}`);
  process.exit(1);
});
